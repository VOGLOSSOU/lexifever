<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>État de l'API Lexifever</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="font-sans bg-gray-50 p-8">
    <div class="max-w-4xl mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">État de l'API Lexifever</h1>
            <p class="text-gray-600">Vérifiez l'état des services et diagnostiquez les problèmes</p>
        </div>

        <!-- État Global -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <i class="fas fa-heartbeat text-green-500 mr-2"></i>
                État Global
            </h2>
            <div id="global-status" class="text-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto mb-4"></div>
                <p class="text-gray-600">Vérification en cours...</p>
            </div>
        </div>

        <!-- Services -->
        <div class="grid md:grid-cols-2 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <i class="fas fa-database text-blue-500 mr-2"></i>
                    Base de Données
                </h3>
                <div id="db-status" class="flex items-center">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-3"></div>
                    <span class="text-gray-600">Vérification...</span>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <i class="fas fa-robot text-purple-500 mr-2"></i>
                    API Gemini
                </h3>
                <div id="gemini-status" class="flex items-center">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-purple-600 mr-3"></div>
                    <span class="text-gray-600">Vérification...</span>
                </div>
            </div>
        </div>

        <!-- Statistiques -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <i class="fas fa-chart-bar text-green-500 mr-2"></i>
                Statistiques d'Utilisation
            </h2>
            <div id="stats-content">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-600 mx-auto mb-4"></div>
                <p class="text-center text-gray-600">Chargement des statistiques...</p>
            </div>
        </div>

        <!-- Actions -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <i class="fas fa-tools text-orange-500 mr-2"></i>
                Actions de Diagnostic
            </h2>
            <div class="grid md:grid-cols-2 gap-4">
                <button onclick="testGeneration()" class="bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-magic mr-2"></i>
                    Tester la Génération
                </button>
                <button onclick="testTranslation()" class="bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 transition-colors">
                    <i class="fas fa-language mr-2"></i>
                    Tester la Traduction
                </button>
                <button onclick="clearCache()" class="bg-yellow-600 text-white px-4 py-3 rounded-lg hover:bg-yellow-700 transition-colors">
                    <i class="fas fa-trash mr-2"></i>
                    Vider le Cache
                </button>
                <button onclick="refreshStatus()" class="bg-gray-600 text-white px-4 py-3 rounded-lg hover:bg-gray-700 transition-colors">
                    <i class="fas fa-refresh mr-2"></i>
                    Actualiser
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration de l'API
        const API_BASE_URL = window.location.pathname.includes('/lexifever/')
            ? window.location.origin + '/lexifever/api'
            : window.location.origin + '/api';

        // Vérifier l'état de l'API
        async function checkAPIStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                const data = await response.json();

                updateGlobalStatus(data);
                updateServiceStatus('db-status', data.services.database === 'OK', 'Base de données');
                updateServiceStatus('gemini-status', data.services.gemini_api === 'OK', 'API Gemini');

                return data;
            } catch (error) {
                console.error('Erreur lors de la vérification:', error);
                updateGlobalStatus({status: 'ERROR', message: error.message});
                return null;
            }
        }

        // Mettre à jour l'état global
        function updateGlobalStatus(data) {
            const statusDiv = document.getElementById('global-status');

            if (data.status === 'OK') {
                statusDiv.innerHTML = `
                    <div class="text-green-600 mb-2">
                        <i class="fas fa-check-circle text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-green-600">Tous les services fonctionnent</h3>
                    <p class="text-gray-600">Version: ${data.version}</p>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div class="text-red-600 mb-2">
                        <i class="fas fa-exclamation-triangle text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-red-600">Problème détecté</h3>
                    <p class="text-gray-600">${data.message || 'Service indisponible'}</p>
                `;
            }
        }

        // Mettre à jour l'état d'un service
        function updateServiceStatus(elementId, isOk, serviceName) {
            const statusDiv = document.getElementById(elementId);

            if (isOk) {
                statusDiv.innerHTML = `
                    <div class="text-green-600 mr-3">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <span class="text-green-600 font-medium">${serviceName} OK</span>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div class="text-red-600 mr-3">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <span class="text-red-600 font-medium">${serviceName} ERROR</span>
                `;
            }
        }

        // Charger les statistiques
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/stats`);
                const data = await response.json();

                if (response.ok) {
                    displayStats(data.data);
                } else {
                    document.getElementById('stats-content').innerHTML = `
                        <div class="text-center text-red-600">
                            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                            <p>Erreur lors du chargement des statistiques</p>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('stats-content').innerHTML = `
                    <div class="text-center text-red-600">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p>Impossible de charger les statistiques</p>
                    </div>
                `;
            }
        }

        // Afficher les statistiques
        function displayStats(data) {
            const statsDiv = document.getElementById('stats-content');

            statsDiv.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-600">${data.texts.total_texts}</div>
                        <div class="text-sm text-gray-600">Textes totaux</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-600">${data.texts.texts_today}</div>
                        <div class="text-sm text-gray-600">Aujourd'hui</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-purple-600">${data.texts.avg_response_time}ms</div>
                        <div class="text-sm text-gray-600">Temps moyen</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-orange-600">${data.domains.total_domains}</div>
                        <div class="text-sm text-gray-600">Domaines</div>
                    </div>
                </div>
            `;
        }

        // Tester la génération de texte
        async function testGeneration() {
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Test en cours...';
            button.disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}/generate-text`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        domain: 'Technologie',
                        topic: 'Intelligence Artificielle',
                        level: 'beginner',
                        tone: 'informative',
                        length: 'short'
                    })
                });

                if (response.ok) {
                    alert('✅ Génération réussie !');
                } else {
                    const error = await response.json();
                    alert('❌ Erreur: ' + (error.error || 'Erreur inconnue'));
                }
            } catch (error) {
                alert('❌ Erreur réseau: ' + error.message);
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Tester la traduction
        async function testTranslation() {
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Test en cours...';
            button.disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}/translate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: 'Hello world',
                        target_language: 'french'
                    })
                });

                if (response.ok) {
                    alert('✅ Traduction réussie !');
                } else {
                    const error = await response.json();
                    alert('❌ Erreur: ' + (error.error || 'Erreur inconnue'));
                }
            } catch (error) {
                alert('❌ Erreur réseau: ' + error.message);
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Vider le cache (simulation)
        function clearCache() {
            alert('🗑️ Cache vidé (simulation)\n\nEn production, cette fonction viderait le cache des réponses API.');
        }

        // Actualiser le statut
        function refreshStatus() {
            checkAPIStatus();
            loadStats();
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            checkAPIStatus();
            loadStats();
        });
    </script>
</body>
</html>